<template lang="pug">
<div id="head" class="site-header" :class="siteHeader">
<div class="site-header__logo">
<svg class="svg__logo" :class="navLogo" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid meet" viewBox="118.02961746691005 116.55873194236085 400.06973241853063 143.38347463407808" width="376.07" height="119.38"><defs><path d="M235.28 137.81C241.04 137.81 245.71 142.48 245.71 148.24C245.71 165.54 245.71 207.01 245.71 224.31C245.71 230.07 241.04 234.74 235.28 234.74C218.01 234.74 176.65 234.74 159.38 234.74C153.62 234.74 148.95 230.07 148.95 224.31C148.95 207.01 148.95 165.54 148.95 148.24C148.95 142.48 153.62 137.81 159.38 137.81C176.65 137.81 218.01 137.81 235.28 137.81Z" id="a2zej57BEw"></path><text id="a14e9gSWuC" x="166.1" y="162.2" font-size="52" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.6471322705180073 -0.7623988203313374 0.7661048213072467 0.6426906456308397 -102.65691078204625 202.19172161741042)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge"><tspan x="166.1" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">1ST</tspan></text> 
    <path d="M231.47 161.27L172.11 224.22L169.89 222.15L229.25 159.2L231.47 161.27Z" id="aU9WW34s"></path><text id="c3Rcf0OEdY" x="222.13" y="215.39" font-size="52" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.6471322705180077 -0.762398820331337 0.7661048213072462 0.6426906456308402 -132.24267374082882 233.11263850146545)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge"><tspan x="222.13" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">IN</tspan></text><text id="d4NuovPZTQ" x="245.71" y="161.67" font-size="80" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.9999961419777894 0.0027777742055340713 -0.0027777742055340713 0.9999961419777894 11.289826075916778 -23.86022231514707)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge"><tspan x="245.71" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">Fashion</tspan></text></defs><g><g><use xlink:href="#a2zej57BEw" opacity="1" fill="#46b7e1" fill-opacity="1"></use></g><g id="c4LuzlRrC"><g><filter id="shadow499895" x="138.1" y="134.2" width="124.53" height="127.49" filterUnits="userSpaceOnUse" primitiveUnits="userSpaceOnUse"><feFlood></feFlood><feComposite in2="SourceAlpha" operator="in"></feComposite><feGaussianBlur stdDeviation="3.16"></feGaussianBlur><feOffset dx="1" dy="1" result="afterOffset"></feOffset><feFlood flood-color="#000000" flood-opacity="0.5"></feFlood><feComposite in2="afterOffset" operator="in"></feComposite><feMorphology operator="dilate" radius="2"></feMorphology><feComposite in2="SourceAlpha" operator="out"></feComposite></filter><text id="b1k3G2SQAb" x="166.1" y="162.2" font-size="52" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.6471322705180073 -0.7623988203313374 0.7661048213072467 0.6426906456308397 -102.65691078204625 202.19172161741042)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge" fill="white" fill-opacity="1" filter="url(#shadow499895)"><tspan x="166.1" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">1ST</tspan></text></g><use xlink:href="#a14e9gSWuC" opacity="0.85" fill="#f6f1f6" fill-opacity="1"></use><g><use xlink:href="#a14e9gSWuC" opacity="0.85" fill-opacity="0" stroke="#090909" stroke-width="1" stroke-opacity="0.84"></use></g></g><g><g><filter id="shadow13874230" x="141.89" y="131.2" width="118.58" height="122.02" filterUnits="userSpaceOnUse" primitiveUnits="userSpaceOnUse"><feFlood></feFlood><feComposite in2="SourceAlpha" operator="in"></feComposite><feGaussianBlur stdDeviation="3.16"></feGaussianBlur><feOffset dx="1" dy="1" result="afterOffset"></feOffset><feFlood flood-color="#000000" flood-opacity="0.5"></feFlood><feComposite in2="afterOffset" operator="in"></feComposite><feMorphology operator="dilate" radius="2"></feMorphology><feComposite in2="SourceAlpha" operator="out"></feComposite></filter><path d="M231.47 161.27L172.11 224.22L169.89 222.15L229.25 159.2L231.47 161.27Z" id="aywmUkM6i" fill="white" fill-opacity="1" filter="url(#shadow13874230)"></path></g><use xlink:href="#aU9WW34s" opacity="0.79" fill="#f6f1f6" fill-opacity="1"></use><g><use xlink:href="#aU9WW34s" opacity="0.79" fill-opacity="0" stroke="#000000" stroke-width="1" stroke-opacity="0.63"></use></g></g><g id="ksJn2eVx"><g><filter id="shadow1309886" x="194.13" y="187.39" width="97.16" height="128.19" filterUnits="userSpaceOnUse" primitiveUnits="userSpaceOnUse"><feFlood></feFlood><feComposite in2="SourceAlpha" operator="in"></feComposite><feGaussianBlur stdDeviation="3.16"></feGaussianBlur><feOffset dx="1" dy="1" result="afterOffset"></feOffset><feFlood flood-color="#000000" flood-opacity="0.5"></feFlood><feComposite in2="afterOffset" operator="in"></feComposite><feMorphology operator="dilate" radius="2"></feMorphology><feComposite in2="SourceAlpha" operator="out"></feComposite></filter><text id="b7vx97PHL" x="222.13" y="215.39" font-size="52" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.6471322705180077 -0.762398820331337 0.7661048213072462 0.6426906456308402 -132.24267374082882 233.11263850146545)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge" fill="white" fill-opacity="1" filter="url(#shadow1309886)"><tspan x="222.13" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">IN</tspan></text></g><use xlink:href="#c3Rcf0OEdY" opacity="0.81" fill="#f6f1f6" fill-opacity="1"></use><g><use xlink:href="#c3Rcf0OEdY" opacity="0.81" fill-opacity="0" stroke="#010101" stroke-width="1" stroke-opacity="0.57"></use></g></g><g id="j1axL1jZ8S"><g><filter id="shadow15328166" x="217.71" y="133.67" width="305.1" height="157" filterUnits="userSpaceOnUse" primitiveUnits="userSpaceOnUse"><feFlood></feFlood><feComposite in2="SourceAlpha" operator="in"></feComposite><feGaussianBlur stdDeviation="3.16"></feGaussianBlur><feOffset dx="1" dy="1" result="afterOffset"></feOffset><feFlood flood-color="#000000" flood-opacity="0.5"></feFlood><feComposite in2="afterOffset" operator="in"></feComposite><feMorphology operator="dilate" radius="2"></feMorphology><feComposite in2="SourceAlpha" operator="out"></feComposite></filter><text id="a3xIbxuGhL" x="245.71" y="161.67" font-size="80" font-family="Patrick Hand" font-weight="normal" font-style="normal" letter-spacing="0" alignment-baseline="before-edge" transform="matrix(0.9999961419777894 0.0027777742055340713 -0.0027777742055340713 0.9999961419777894 11.289826075916778 -23.86022231514707)" style="line-height:100%" xml:space="preserve" dominant-baseline="text-before-edge" fill="white" fill-opacity="1" filter="url(#shadow15328166)"><tspan x="245.71" dy="0em" alignment-baseline="before-edge" dominant-baseline="text-before-edge" text-anchor="start">Fashion</tspan></text></g><use xlink:href="#d4NuovPZTQ" opacity="1" fill="#46b7e1" fill-opacity="1"></use><g><use xlink:href="#d4NuovPZTQ" opacity="1" fill-opacity="0" stroke="#010101" stroke-width="1" stroke-opacity="0.76"></use></g></g></g></svg>           
</div>
<div class="site-header__menu-icon" :class="menuIcon" @click="navDisplay">
	
	
<div class="site-header__menu-icon__middle" ></div>
	
	
	
</div>
	
<div class="site-header__menu-content" :class="menuContent">
<nav class="primary-nav primary-nav--pull-right">
<ul>
<li><router-link tag="a" to="/" name="kids_home" id="fashion_home">home<span class="caret">&nbsp;</span></router-link></li>
<li v-for="item in categories"><router-link tag="a" :to="'/category/'+item.category" id="fashion categories" :class="navClasses">{{item.category}}</router-link></li>
</ul>
</nav>
</div>
<div class="basket" :class="applyhover">
<p class="basket__default"><font-awesome-icon icon="shopping-basket" class="basket__icon"/>{{basketcontents.length}} Items<font-awesome-icon icon="caret-down" class="caret--items" /></p>
<span class="basket__details">
<div class="basket__products">
<table>
<tr>
<th>Product name</th>
<th>Size</th>
<th>Price</th>
<th>Remove</th>
</tr>
<tr v-for="products in basketcontents">
<td>{{products.name}}</td>
<td>{{products.size}}</td>
<td>{{products.price}}</td>
<td><font-awesome-icon icon="minus-circle"/><a href="#" @click="$emit('remove', products.basketId)">Remove</a></td>
</tr>
</table>
</div>
<p class="basket__total">total: &#163;{{baskettotal}}</p>
<div class="basket__checkout">
<div  ref="paypal"></div>
</div>
</span>
</div>
</div>
</template>
 
<script>
import Axios from 'axios'
let postJson
let postInfo = {}
import throttle from 'lodash/throttle'
import debounce from 'lodash/debounce'



export default{

name: 'Sitenav', 

  data(){ 
  return { browserHeight: 0, previousScrollY: 0, scrollDirection: null, siteHeader: [], menuContent: [], menuIcon:[], navClasses: [], navLogo: ['svg__logo--dark'], navBtn: ['btn--dark','btn--white'], mobileNav: false, loaded: false }
  
  },
  created(){

 const script = document.createElement('script')
    script.src =
      "https://www.paypal.com/sdk/js?client-id=Ab1o3HYYOP8crQG21uyx8EMASXUnQ1sRX6_G3uPcJKxz_3zkIdUag9hOmm1AZV8jLEr3PU0yBWhFSf14&currency=GBP&intent=authorize"
    document.body.appendChild(script)
    
	  
  },
props: ['products', 'categories', 'basketcontents', 'baskettotal', 'paypalitems', 'applyhover'],
watch: {
'$route' (){

this.navDisplayClose()
 

},
'basketcontents' (){

this.setLoaded()

}

},

methods: {
	setLoaded(){
	this.loaded = true
	  paypal
        .Buttons({
          createOrder: (data, actions) => {
            return actions.order.create({
              purchase_units: [{
                     amount: {
                      currency_code: "GBP",
                       value: ""+this.baskettotal+"",
                      breakdown: {
                        item_total: {currency_code:"GBP", value:""+this.baskettotal+""}
						}
                     },
                 items: this.paypalitems
        }],
		})
		 },
onShippingChange: (data, actions) => {
      
		  //handle shipping rules
		const euro = ['FR','DK','EE','FI','DE','GR','IE','IT','LV','NL','NO','PL','PT','ES','SE','UA']
		let isEuro = false
		
		for (let country in euro){
		
		if(euro[country] === data.shipping_address.country_code){
		
		isEuro = true
		
		break
		}
		
		}
		let shippingAmount
		
        if (data.shipping_address.country_code === 'GB') {
         
        
		
        if(this.baskettotal >= 20){
		
		 shippingAmount = '0.00'
		}
		else
		{

        // uk shipping Amount
         shippingAmount = '3.00'
	    }
		
        return actions.order.patch([
            {
                op: 'replace',
                path: '/purchase_units/@reference_id==\'default\'/amount',
                value: {
                    currency_code: 'GBP',
                    value: (parseFloat(this.baskettotal) + parseFloat(shippingAmount)).toFixed(2),
                    breakdown: {
                        item_total: {
                            currency_code: 'GBP',
                            value: this.baskettotal
                        },
                        shipping: {
                            currency_code: 'GBP',
                            value: shippingAmount
                        }
                    }
                }
            }
        ])
    }else if (isEuro === true){
	// euro shipping Amount
         shippingAmount = '7.00'
        return actions.order.patch([
            {
                op: 'replace',
                path: '/purchase_units/@reference_id==\'default\'/amount',
                value: {
                    currency_code: 'GBP',
                    value: (parseFloat(this.baskettotal) + parseFloat(shippingAmount)).toFixed(2),
                    breakdown: {
                        item_total: {
                            currency_code: 'GBP',
                            value: this.baskettotal
                        },
                        shipping: {
                            currency_code: 'GBP',
                            value: shippingAmount
                        }
                    }
                }
            }
        ])
	
	
	}
	else{
	// ROW shipping Amount
        shippingAmount = '12.00'
        return actions.order.patch([
            {
                op: 'replace',
                path: '/purchase_units/@reference_id==\'default\'/amount',
                value: {
                    currency_code: 'GBP',
                    value: (parseFloat(this.baskettotal) + parseFloat(shippingAmount)).toFixed(2),
                    breakdown: {
                        item_total: {
                            currency_code: 'GBP',
                            value: this.baskettotal
                        },
                        shipping: {
                            currency_code: 'GBP',
                            value: shippingAmount
                        }
                    }
                }
            }
        ])
	
	
	}
	},		 
          onApprove: async (data, actions) => {
		   const basket = this.basketcontents.map(function(item) {
		
		return item.productimg })
		   this.$emit('remove', 'all')
		   const alert = document.createElement('div')
			alert.className = 'confirmed'
			alert.innerHTML = `<img class='confirmed__loading' src="/assets/images/loading.gif" alt="loading order details">`
			document.body.appendChild(alert)
		    const order = await actions.order.authorize()
			this.compileEmail(order, basket)
            let listItems = `<table class="confirmed__items">
			<tr>
			<th>Item</th>
			<th>Qty</th>
			</tr>`
            this.paidFor = true
			for( let key in order.purchase_units[0].items){
			
			 listItems += `<tr><td>${order.purchase_units[0].items[key].name}</td><td>${order.purchase_units[0].items[key].quantity}</td></tr>`
			
			}
			
			listItems += `</table>`
			
            if(order.status === 'COMPLETED') {
			alert.addEventListener('click' , this.closeorder)
			alert.innerHTML = `<h1 class="confirmed__title">Details Confirmed</h1>
			                    <p class="confirmed__details">Thank's for your order of.<br></p>
								 ${listItems}
								 <p class="confirmed__details">Once we confirm stock we will charge your prefered payment method.
								 You will recieve an order/payment confirmation email. 
								 Letting you know this has taken place and your order will be shipped to.<br>
								 <span class="confirmed__address">
								 ${order.purchase_units[0].shipping.address.address_line_1}<br>
								 ${order.purchase_units[0].shipping.address.admin_area_1}<br>
								 ${order.purchase_units[0].shipping.address.postal_code}<br>
								 </span>
								 Thanks for shopping with us we hope you enjoy your experince</p>
								<button class="confirmed__close" value="close">Close</button>`
			
			
			
			
			}
          },
          onError: err => {
            console.log(err);
          }
        })
        .render(this.$refs.paypal)
	
	},

navDisplay() {
if (this.mobileNav === false){


 this.siteHeader.push('site-header--is-expanded')
 this.menuContent.push('site-header__menu-content--is-visible')
 this.menuIcon.push('site-header__menu-icon--close-x')
 return this.mobileNav = true
}
else (this.mobileNav === true)
{

 this.navDisplayClose()
 

}

},
navDisplayClose(){

this.siteHeader = []
 this.menuContent = []
 this.menuIcon = []
 return this.mobileNav = false

},
compileEmail(order, basket){
 console.log(order)
  let listItems = `<table class="confirmed__items">
			<tr>
			<th>Item</th>
			<th>Qty</th>
			</tr>`
			for( let key in order.purchase_units[0].items){
			
		   
			
			 listItems += `<tr><td>${order.purchase_units[0].items[key].name}</td><td>${order.purchase_units[0].items[key].quantity}</td></tr>
			               <tr><td><a href="https://www.1stinfashion.co.uk/assets/images${basket[key]}">View Image</a></td></tr>`
			
			}
			
			listItems += `<tr><td>total:</td><td>£${order.purchase_units[0].amount.value}</td></tr></table>`
	
	postInfo['item'] = listItems
	postInfo['address'] = `${order.purchase_units[0].shipping.address.address_line_1}<br>
						 ${order.purchase_units[0].shipping.address.admin_area_1}<br>
					     ${order.purchase_units[0].shipping.address.postal_code}<br>`
    postInfo['email'] = order.payer.email_address
	
	
		
		postJson = JSON.stringify(postInfo)
		this.sendrequest()
	
				
	

},

sendrequest(){
	
	Axios.post('/.netlify/functions/orderemails', postJson )
},
 closeorder(e){
 
 if(e.target.getAttribute('value') === 'close'){
 
  const alert = document.querySelector('.confirmed')
  alert.remove()
 
 
 }

 
}









}


}

 

</script>